AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'Functions for ARM and x86

  '
Resources:
  ARMGo:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: ArmGolang
      CodeUri: ARMGo
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
      - arm64
      Timeout: 120
      Policies:
      - AWSLambdaExecute
      - DynamoDBWritePolicy:
          TableName:
            Ref: ARMDynamoDBTable
      Environment:
        Variables:
          TABLE_NAME:
            Ref: ARMDynamoDBTable
    Metadata:
      BuildMethod: makefile
      SamResourceId: ARMGo
  ARMGoURL:
    Type: AWS::Lambda::Url
    Properties:
      AuthType: NONE
      TargetFunctionArn:
        Ref: ARMGo
  permissionForURLInvokeArm:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Ref: ARMGo
      FunctionUrlAuthType: NONE
      Action: lambda:InvokeFunctionUrl
      Principal: '*'
  permissionForURLInvokeIntel:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName:
        Ref: GoIntel
      FunctionUrlAuthType: NONE
      Action: lambda:InvokeFunctionUrl
      Principal: '*'
  GoIntel:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: x86Golang
      CodeUri: GoIntel
      Handler: bootstrap
      Runtime: provided.al2
      Architectures:
      - x86_64
      Timeout: 120
      Policies:
      - AWSLambdaExecute
      - DynamoDBWritePolicy:
          TableName:
            Ref: ARMDynamoDBTable
      Environment:
        Variables:
          TABLE_NAME:
            Ref: ARMDynamoDBTable
    Metadata:
      BuildMethod: makefile
      SamResourceId: GoIntel
  GoIntelURL:
    Type: AWS::Lambda::Url
    Properties:
      AuthType: NONE
      TargetFunctionArn:
        Ref: GoIntel
  ARMDynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: ARMDynamo
      AttributeDefinitions:
      - AttributeName: Email
        AttributeType: S
      - AttributeName: Date
        AttributeType: S
      KeySchema:
      - AttributeName: Email
        KeyType: HASH
      - AttributeName: Date
        KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      ProvisionedThroughput:
        ReadCapacityUnits: 0
        WriteCapacityUnits: 0
Outputs:
  ARMDynamo:
    Value:
      Ref: ARMDynamoDBTable
    Description: DynamoDb Table to test lambdas
  ARMGoLambdafn:
    Value:
      Ref: ARMGo
    Description: Fn for Go ARM
  ARMGoLambdaURL:
    Value:
      Fn::GetAtt:
      - ARMGoURL
      - FunctionUrl
  x86GoLambdafn:
    Value:
      Ref: GoIntelURL
    Description: Fn for Go ARM
  x86GoLambdaURL:
    Value:
      Fn::GetAtt:
      - GoIntelURL
      - FunctionUrl
